<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Comick-style Immersive Reader</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/epubjs/dist/epub.min.js"></script>
  <style>
    :root{--bg:#0d0d0f;--panel:#121216;--muted:#9b9b9b;--accent:#f5f5dc;}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Playfair Display',serif;background:var(--bg);color:var(--accent);}
    #app{display:flex;min-height:100vh}
    #sidebar{width:320px;padding:28px;background:linear-gradient(180deg,#0b0b0d,#0f0f12);border-right:1px solid rgba(255,255,255,0.03);}
    #main{flex:1;padding:28px;display:flex;flex-direction:column;align-items:center;}
    h1{margin:0 0 12px 0;font-size:20px;letter-spacing:1px}
    .add-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:var(--accent);cursor:pointer;transition:all .18s ease}
    .add-btn:hover{border-color:var(--accent);}
    .tiles{display:flex;flex-wrap:wrap;gap:18px}
    .tile{width:160px;height:240px;border-radius:10px;overflow:hidden;position:relative;background:#18181a;box-shadow:0 6px 18px rgba(0,0,0,0.6);cursor:pointer;transition:transform .25s,box-shadow .25s}
    .tile img{width:100%;height:100%;object-fit:cover;display:block}
    .tile:hover{transform:translateY(-6px) scale(1.02);box-shadow:0 12px 30px rgba(0,0,0,0.7)}
    .tile .meta{position:absolute;left:0;right:0;bottom:0;padding:10px;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.6));}
    #readerWrap{display:none;flex-direction:column;align-items:center;position:relative;width:100%;height:100vh}
    #readerHeader{width:100%;display:flex;justify-content:space-between;align-items:center;padding:22px 40px;position:fixed;top:0;left:0;z-index:50;background:linear-gradient(180deg,rgba(10,10,10,0.9),transparent);backdrop-filter:blur(2px)}
    #viewerContainer{width:820px;max-width:92%;margin-top:98px;margin-bottom:80px;position:relative}
    #viewer{background:rgba(0,0,0,0.35);padding:36px 48px;border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,0.7);max-height:74vh;overflow:auto}
    @media(max-width:900px){#sidebar{display:none}#viewer{padding:22px}}
  </style>
</head>
<body>
  <div id="app">
    <aside id="sidebar">
      <h1>Comick Library</h1>
      <div class="controls">
        <label class="add-btn">Add EPUB<input id="epubInput" type="file" accept=".epub" style="display:none"></label>
        <label class="add-btn">Add Cover<input id="coverInput" type="file" accept="image/*" style="display:none"></label>
      </div>
      <div id="statusMsg" style="color:var(--muted);font-size:13px;margin-top:10px">Ready</div>
    </aside>

    <main id="main">
      <div id="homepageView">
        <h2>Your Library</h2>
        <div class="tiles" id="tiles"></div>
      </div>

      <div id="readerWrap">
        <div id="readerHeader">
          <h2 id="seriesTitle">Series</h2>
          <button id="gotoHome" class="add-btn">Library</button>
        </div>
        <div id="viewerContainer"><div id="viewer"></div></div>
      </div>
    </main>
  </div>

  <script>
  /* ========= IndexedDB setup ========= */
  const DB_NAME='comickDBv2', STORE='seriesStore'; let db;
  async function openDB(){
    return new Promise((res,rej)=>{
      const req=indexedDB.open(DB_NAME,1);
      req.onupgradeneeded=e=>{
        db=e.target.result;
        db.createObjectStore(STORE,{keyPath:'id'});
      };
      req.onsuccess=e=>{db=e.target.result;res(db);}
      req.onerror=e=>rej(e);
    });
  }
  async function saveSeries(obj){
    if(!db) await openDB();
    const tx=db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).put(obj);
    return new Promise(r=>tx.oncomplete=r);
  }
  async function getAllSeries(){
    if(!db) await openDB();
    const tx=db.transaction(STORE,'readonly');
    const req=tx.objectStore(STORE).getAll();
    return new Promise(r=>req.onsuccess=()=>r(req.result));
  }
  async function getSeries(id){
    if(!db) await openDB();
    const tx=db.transaction(STORE,'readonly');
    const req=tx.objectStore(STORE).get(id);
    return new Promise(r=>req.onsuccess=()=>r(req.result));
  }

  /* ========= UI logic ========= */
  const epubInput=document.getElementById('epubInput');
  const coverInput=document.getElementById('coverInput');
  const tiles=document.getElementById('tiles');
  const statusMsg=document.getElementById('statusMsg');
  const readerWrap=document.getElementById('readerWrap');
  const homepageView=document.getElementById('homepageView');
  const viewer=document.getElementById('viewer');
  const seriesTitle=document.getElementById('seriesTitle');
  const gotoHome=document.getElementById('gotoHome');
  let currentSeries=null;

  let tempCover=null;
  coverInput.addEventListener('change',async e=>{
    const file=e.target.files[0];
    if(file){
      const buf=await file.arrayBuffer();
      tempCover=new Blob([buf],{type:file.type});
      statusMsg.textContent='Cover loaded.';
    }
  });

  epubInput.addEventListener('change',async e=>{
    const file=e.target.files[0];
    if(!file) return;
    statusMsg.textContent='Processing EPUB...';
    const id=Date.now().toString();
    const buf=await file.arrayBuffer();
    const epubBlob=new Blob([buf],{type:file.type});
    const coverBlob=tempCover||null;
    const meta={id,title:file.name.replace('.epub',''),epubBlob,coverBlob};
    await saveSeries(meta);
    statusMsg.textContent='Saved to library.';
    tempCover=null;
    renderLibrary();
  });

  async function renderLibrary(){
    tiles.innerHTML='';
    const all=await getAllSeries();
    if(!all.length){tiles.innerHTML='<p style="color:var(--muted)">No books yet.</p>';return;}
    for(const s of all){
      const div=document.createElement('div');div.className='tile';div.dataset.id=s.id;
      let coverURL=''; if(s.coverBlob){coverURL=URL.createObjectURL(s.coverBlob);}
      div.innerHTML=`<img src="${coverURL||'https://placehold.co/160x240?text=No+Cover'}"><div class="meta"><div>${s.title}</div></div>`;
      div.onclick=()=>openReader(s.id);
      tiles.appendChild(div);
    }
  }

  async function openReader(id){
    const s=await getSeries(id);
    if(!s){alert('Not found');return;}
    currentSeries=s;
    seriesTitle.textContent=s.title;
    homepageView.style.display='none';
    readerWrap.style.display='flex';
    viewer.innerHTML='';
    statusMsg.textContent='Loading reader...';
    const blobURL=URL.createObjectURL(s.epubBlob);
    const book=ePub(blobURL);
    const rendition=book.renderTo("viewer",{width:"100%",height:"70vh"});
    rendition.display();
    statusMsg.textContent='Reading.';
  }

  gotoHome.onclick=()=>{
    readerWrap.style.display='none';
    homepageView.style.display='block';
    renderLibrary();
  };

  openDB().then(renderLibrary);
  </script>
</body>
</html>
