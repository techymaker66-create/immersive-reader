<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Comick-style Immersive Reader</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/epubjs/dist/epub.min.js"></script>
<style>
:root{--bg:#0d0d0f;--accent:#f5f5dc;--muted:#9b9b9b;}
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:'Playfair Display',serif;background:var(--bg);color:var(--accent);}
#app{display:flex;min-height:100vh;}
#sidebar{width:280px;padding:20px;background:linear-gradient(180deg,#0b0b0d,#0f0f12);border-right:1px solid rgba(255,255,255,0.05);}
#main{flex:1;padding:20px;display:flex;flex-direction:column;}
h1{margin-top:0;font-size:20px;}
.controls{margin-bottom:20px;}
.add-btn{background:transparent;border:1px solid rgba(255,255,255,0.1);padding:8px 12px;border-radius:6px;color:var(--accent);cursor:pointer;display:inline-block;margin-bottom:5px;}
.add-btn:hover{border-color:var(--accent);}
.tiles{display:flex;flex-wrap:wrap;gap:12px;}
.tile{width:140px;height:220px;background:#18181a;border-radius:8px;overflow:hidden;position:relative;cursor:pointer;transition:0.2s;}
.tile:hover{transform:scale(1.03);}
.tile img{width:100%;height:100%;object-fit:cover;}
.tile .meta{position:absolute;bottom:0;left:0;right:0;padding:6px;background:rgba(0,0,0,0.6);color:var(--accent);font-size:12px;}
#readerWrap{display:none;flex-direction:column;align-items:center;width:100%;height:100vh;}
#readerHeader{width:100%;display:flex;justify-content:space-between;align-items:center;padding:16px 24px;background:rgba(0,0,0,0.85);}
#viewerContainer{width:80%;max-width:800px;margin-top:60px;margin-bottom:40px;}
#viewer{width:100%;height:70vh;overflow:auto;background:rgba(0,0,0,0.3);padding:24px;border-radius:12px;}
.nav{display:flex;justify-content:space-between;width:80%;max-width:800px;margin-top:10px;}
.nav button{padding:10px 16px;border:none;border-radius:6px;background:#222;color:var(--accent);cursor:pointer;}
.nav button:hover{background:#333;}
@media(max-width:800px){#sidebar{display:none}#viewerContainer{width:95%;}}
</style>
</head>
<body>
<div id="app">
<aside id="sidebar">
<h1>Comick Library</h1>
<div class="controls">
<label class="add-btn">Add EPUB<input id="epubInput" type="file" accept=".epub" style="display:none"></label><br>
<label class="add-btn">Upload Cover<input id="coverInput" type="file" accept="image/*" style="display:none"></label><br>
<button id="addSeriesBtn" class="add-btn">Add Series</button>
</div>
<div id="statusMsg" style="font-size:13px;color:var(--muted)">Ready</div>
</aside>

<main id="main">
<div id="homepageView">
<h2>Your Library</h2>
<div class="tiles" id="tiles"></div>
</div>

<div id="readerWrap">
<div id="readerHeader">
<h2 id="seriesTitle">Series</h2>
<button id="gotoHome">Library</button>
</div>
<div id="viewerContainer">
<div id="viewer"></div>
</div>
<div class="nav">
<button id="prevBtn">⟵ Prev</button>
<button id="nextBtn">Next ⟶</button>
</div>
</div>
</main>
</div>

<script>
const DB_NAME='comickDB',STORE_NAME='seriesStore';
let db,currentBook,currentSeries,rendition,tempEPUB=null,tempCover=null;

// IndexedDB
function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,1);
    req.onupgradeneeded=e=>{db=e.target.result;db.createObjectStore(STORE_NAME,{keyPath:'id'});};
    req.onsuccess=e=>{db=e.target.result;resolve(db);};
    req.onerror=e=>reject(e);
  });
}

async function getSeries(){
  if(!db) await openDB();
  return new Promise(res=>{
    const tx=db.transaction(STORE_NAME,'readonly');
    const store=tx.objectStore(STORE_NAME);
    const r=store.getAll();
    r.onsuccess=()=>res(r.result);
  });
}

async function saveSeries(series){
  if(!db) await openDB();
  return new Promise(res=>{
    const tx=db.transaction(STORE_NAME,'readwrite');
    tx.objectStore(STORE_NAME).put(series).onsuccess=()=>{res();}
  });
}

async function deleteSeries(id){
  if(!db) await openDB();
  return new Promise(res=>{
    const tx=db.transaction(STORE_NAME,'readwrite');
    tx.objectStore(STORE_NAME).delete(id).onsuccess=()=>res();
  });
}

// UI
const tiles=document.getElementById('tiles'),
      epubInput=document.getElementById('epubInput'),
      coverInput=document.getElementById('coverInput'),
      statusMsg=document.getElementById('statusMsg');

epubInput.addEventListener('change',e=>{tempEPUB=e.target.files[0];});
coverInput.addEventListener('change',e=>{tempCover=e.target.files[0];});

document.getElementById('addSeriesBtn').addEventListener('click',()=>{
  if(!tempEPUB) return alert('Select an EPUB file first');
  const id=Date.now().toString(),title=tempEPUB.name;
  saveSeries({id,title,epubBlob:tempEPUB,coverBlob:tempCover||null}).then(()=>{
    tempEPUB=null; tempCover=null; epubInput.value=''; coverInput.value='';
    renderTiles();
  });
});

function renderTiles(){
  getSeries().then(list=>{
    tiles.innerHTML='';
    list.forEach(series=>{
      const tile=document.createElement('div');tile.className='tile';
      const img=document.createElement('img');
      img.src=series.coverBlob?URL.createObjectURL(series.coverBlob):'https://via.placeholder.com/140x220?text=Cover';
      tile.appendChild(img);
      const meta=document.createElement('div');meta.className='meta';meta.textContent=series.title;tile.appendChild(meta);
      tiles.appendChild(tile);

      tile.addEventListener('click',()=>openBook(series));
      tile.addEventListener('contextmenu',e=>{e.preventDefault();
        if(confirm('Delete "'+series.title+'" from library?')){deleteSeries(series.id).then(renderTiles);}
      });
    });
  });
}

async function openBook(series){
  currentSeries=series;
  document.getElementById('homepageView').style.display='none';
  document.getElementById('readerWrap').style.display='flex';
  document.getElementById('seriesTitle').textContent=series.title;
  const arrayBuffer=await series.epubBlob.arrayBuffer();
  currentBook=ePub(arrayBuffer);
  rendition=currentBook.renderTo("viewer",{width:"100%",height:"100%"});
  rendition.display();
  document.getElementById('nextBtn').onclick=()=>rendition.next();
  document.getElementById('prevBtn').onclick=()=>rendition.prev();
}

document.getElementById('gotoHome').addEventListener('click',()=>{
  document.getElementById('readerWrap').style.display='none';
  document.getElementById('homepageView').style.display='block';
});

renderTiles();
</script>
</body>
</html>
