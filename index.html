<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Immersive Reader v2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/epubjs/dist/epub.min.js"></script>
  <style>
    body { background: radial-gradient(circle at top left, #0d1117, #050608 70%); overflow: hidden; }
    .orb {
      position: fixed; pointer-events: none; width: 28px; height: 28px;
      border-radius: 50%; mix-blend-mode: screen;
      background: radial-gradient(circle, rgba(80,180,255,0.5) 0%, transparent 70%);
      box-shadow: 0 0 30px rgba(80,180,255,0.3);
      transition: transform 0.15s ease, width 0.15s, height 0.15s;
      z-index: 50;
    }
    .orb.hover { width: 48px; height: 48px; box-shadow: 0 0 60px rgba(80,180,255,0.4); }
    #readerHeader { backdrop-filter: blur(12px); background: rgba(20,25,30,0.4); transition: transform 0.3s ease; }
    #viewer iframe { width: 100% !important; height: 100% !important; }
  </style>
</head>
<body class="h-screen flex flex-col text-gray-100 font-serif">

  <div class="flex flex-1">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-72 bg-black/30 backdrop-blur-lg border-r border-white/10 p-4 flex flex-col space-y-4">
      <h1 class="text-lg font-bold">ðŸ“š Library</h1>

      <div class="flex flex-col gap-2">
        <input id="epubFile" type="file" accept=".epub" class="text-sm bg-white/5 p-2 rounded" />
        <input id="coverFile" type="file" accept="image/*" class="text-sm bg-white/5 p-2 rounded" />
        <button id="addBtn" class="bg-blue-500/80 hover:bg-blue-600 text-white rounded py-1.5">Add EPUB</button>
      </div>

      <div id="library" class="grid grid-cols-2 gap-3 overflow-y-auto flex-1 p-1"></div>
    </aside>

    <!-- Reader -->
    <main class="flex-1 relative overflow-hidden">
      <header id="readerHeader" class="sticky top-0 z-40 flex items-center justify-between p-3 border-b border-white/10">
        <h2 id="bookTitle" class="font-semibold text-white/90">No book open</h2>
        <div class="flex gap-2">
          <button id="backBtn" class="px-2 py-1 text-sm bg-white/10 hover:bg-white/20 rounded">Library</button>
          <button id="downloadBtn" class="px-2 py-1 text-sm bg-white/10 hover:bg-white/20 rounded">Download</button>
        </div>
      </header>

      <section id="viewer" class="absolute inset-0 overflow-auto p-8 text-lg leading-relaxed text-gray-200"></section>

      <div class="absolute bottom-4 inset-x-0 flex justify-center gap-3">
        <button id="prevBtn" class="bg-white/10 hover:bg-white/20 px-3 py-1 rounded">â—€ Prev</button>
        <button id="nextBtn" class="bg-white/10 hover:bg-white/20 px-3 py-1 rounded">Next â–¶</button>
      </div>
    </main>
  </div>

  <div id="orb" class="orb"></div>

  <script>
    const orb = document.getElementById('orb');
    const epubFile = document.getElementById('epubFile');
    const coverFile = document.getElementById('coverFile');
    const addBtn = document.getElementById('addBtn');
    const library = document.getElementById('library');
    const viewer = document.getElementById('viewer');
    const backBtn = document.getElementById('backBtn');
    const bookTitle = document.getElementById('bookTitle');
    const downloadBtn = document.getElementById('downloadBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    let active = null, book = null, rendition = null, epubUrl = null;

    // IndexedDB wrapper
    const DB = 'immReaderDB'; const STORE = 'series';
    function openDB() {
      return new Promise((res, rej) => {
        const req = indexedDB.open(DB, 1);
        req.onupgradeneeded = e => e.target.result.createObjectStore(STORE, { keyPath: 'id' });
        req.onsuccess = () => res(req.result);
        req.onerror = () => rej(req.error);
      });
    }
    async function tx(mode, fn) {
      const db = await openDB();
      return new Promise((res, rej) => {
        const tx = db.transaction(STORE, mode);
        const store = tx.objectStore(STORE);
        const r = fn(store);
        tx.oncomplete = () => res(r.result);
        tx.onerror = () => rej(tx.error);
      });
    }

    async function refreshLibrary() {
      const series = await tx('readonly', s => s.getAll());
      library.innerHTML = '';
      if (!series.length) {
        library.innerHTML = `<p class="text-gray-500 text-sm col-span-2">No EPUBs added yet.</p>`;
      }
      series.forEach(item => {
        const div = document.createElement('div');
        div.className = 'bg-white/5 rounded-lg p-2 hover:bg-white/10 cursor-pointer flex flex-col gap-2';
        div.innerHTML = `
          <div class="aspect-[3/4] bg-black/50 rounded overflow-hidden flex items-center justify-center">
            ${item.cover ? `<img src="${URL.createObjectURL(item.cover)}" class="object-cover w-full h-full"/>` : '<span class="text-xs text-gray-500">No Cover</span>'}
          </div>
          <p class="text-xs text-center truncate">${item.title}</p>`;
        div.onclick = () => openBook(item.id);
        div.oncontextmenu = (e) => { e.preventDefault(); if (confirm(`Delete "${item.title}"?`)) tx('readwrite', s => s.delete(item.id)).then(refreshLibrary); };
        library.appendChild(div);
      });
    }

    addBtn.onclick = async () => {
      if (!epubFile.files[0]) return alert('Select an EPUB first.');
      const epubBlob = epubFile.files[0];
      const coverBlob = coverFile.files[0] || null;
      const entry = { id: Date.now(), title: epubBlob.name.replace(/\.epub$/i, ''), epub: epubBlob, cover: coverBlob };
      await tx('readwrite', s => s.add(entry));
      epubFile.value = ''; coverFile.value = '';
      refreshLibrary();
    };

    async function openBook(id) {
      const data = await tx('readonly', s => s.get(id));
      if (!data) return;
      active = data;
      bookTitle.textContent = data.title;
      epubUrl && URL.revokeObjectURL(epubUrl);
      epubUrl = URL.createObjectURL(data.epub);
      viewer.innerHTML = '';
      book = ePub(epubUrl);
      rendition = book.renderTo('viewer', { width: '100%', height: '100%' });
      rendition.themes.default({ body: { color: '#f0f4f8', background: 'transparent', 'font-family': 'Georgia, serif', 'line-height': '1.6' } });
      rendition.display();
    }

    backBtn.onclick = () => { viewer.innerHTML = ''; bookTitle.textContent = 'No book open'; };
    downloadBtn.onclick = () => { if (!active) return; const a = document.createElement('a'); a.href = URL.createObjectURL(active.epub); a.download = active.title + '.epub'; a.click(); };
    prevBtn.onclick = () => rendition?.prev();
    nextBtn.onclick = () => rendition?.next();

    // Floating orb
    document.addEventListener('mousemove', e => {
      orb.style.left = e.clientX + 'px';
      orb.style.top = e.clientY + 'px';
    });
    document.addEventListener('mouseover', e => { if (e.target.closest('button,div,aside')) orb.classList.add('hover'); });
    document.addEventListener('mouseout', e => { if (!e.relatedTarget || !e.relatedTarget.closest('button,div,aside')) orb.classList.remove('hover'); });

    // Parallax header motion
    const readerHeader = document.getElementById('readerHeader');
    viewer.addEventListener('scroll', () => {
      const y = viewer.scrollTop;
      readerHeader.style.transform = `translateY(${Math.min(y * 0.1, 20)}px)`;
    });

    refreshLibrary();
  </script>
</body>
</html>
