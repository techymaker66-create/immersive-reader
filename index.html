<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NightLit Reader</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- React + ReactDOM CDN -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

<!-- Babel CDN for JSX -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- epub.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

</head>
<body class="bg-[#07111a] text-[#e6eef8]">

<div id="root" class="min-h-screen"></div>

<script type="text/babel">

const { useState, useEffect, useRef } = React;

// Helper: lightweight ID
function bookId(name, size) {
  const s = `${name}:${size}`;
  let h = 0;
  for (let i = 0; i < s.length; i++) h = (h << 5) - h + s.charCodeAt(i);
  return `b_${Math.abs(h)}`;
}

const STORAGE_KEY = "webnovel_reader_library_v1";

function App() {
  const [library, setLibrary] = useState(() => {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]"); }
    catch(e){return [];}
  });
  const [activeBookId, setActiveBookId] = useState(null);
  const [bookObj,setBookObj]=useState(null);
  const [rendition,setRendition]=useState(null);
  const [isReading,setIsReading]=useState(false);
  const [progress,setProgress]=useState(0);
  const [toc,setToc]=useState([]);
  const viewerRef = useRef(null);
  const [showLibrary,setShowLibrary]=useState(true);

  useEffect(()=>{localStorage.setItem(STORAGE_KEY,JSON.stringify(library));},[library]);

  async function handleEpubUpload(e){
    const files = e.target.files;
    if(!files||files.length===0) return;
    for(const file of files){
      const id = bookId(file.name,file.size);
      const arrayBuffer = await file.arrayBuffer();
      const blob = new Blob([arrayBuffer],{type:"application/epub+zip"});
      const url = URL.createObjectURL(blob);

      const b = ePub(url);
      await b.ready;
      const metadata = await b.loaded.metadata;
      const title = (metadata && metadata.title)?metadata.title:file.name.replace(/\.epub$/i,"");

      let coverDataUrl=null;
      try{ const cover=b.coverUrl(); if(cover){ coverDataUrl=cover; } } catch(e){}

      const newItem = {id,title,fileName:file.name,size:file.size,url,cover:coverDataUrl,lastCfi:null,percent:0,addedAt:Date.now()};
      setLibrary(prev=>[newItem,...prev.filter(p=>p.id!==id)]);
      try{ b.destroy && b.destroy(); }catch(e){}
    }
    e.target.value="";
  }

  async function openBook(bid){
    setShowLibrary(false); setActiveBookId(bid);
    const bookMeta = library.find(x=>x.id===bid);
    if(!bookMeta) return;

    try{ rendition && rendition.destroy(); bookObj && bookObj.destroy && bookObj.destroy(); } catch(e){}
    const book = ePub(bookMeta.url); setBookObj(book);
    await book.ready; if(!book.locations||!book.locations.length) await book.locations.generate(1600);
    const r = book.renderTo(viewerRef.current,{width:"100%",height:"100%",flow:"paginated"});
    r.themes.default({body:{background:"#0b1220",color:"#e6eef8",fontFamily:"Inter, ui-sans-serif, system-ui"}});
    r.on("relocated",loc=>{
      const cfi=loc.start.cfi;
      let p=0;
      try{ if(book.locations && book.locations.length) p=Math.round(book.locations.percentageFromCfi(cfi)*100); } catch(e){p=0;}
      setProgress(p);
      setLibrary(prev=>prev.map(it=>it.id===bid?{...it,lastCfi:cfi,percent:p}:it));
    });
    r.display(bookMeta.lastCfi||undefined); setRendition(r);
    const _toc = await book.getToc(); setToc(_toc); setIsReading(true);
  }

  function closeReader(){ try{rendition&&rendition.destroy();}catch(e){} setRendition(null); setBookObj(null); setActiveBookId(null); setIsReading(false); setShowLibrary(true);}
  function gotoPrev(){rendition&&rendition.prev();}
  function gotoNext(){rendition&&rendition.next();}
  function jumpToCfi(cfi){rendition&&rendition.display(cfi);}
  function removeBook(id){ const b=library.find(x=>x.id===id); if(b&&b.url) URL.revokeObjectURL(b.url); setLibrary(prev=>prev.filter(x=>x.id!==id)); if(activeBookId===id) closeReader(); }

  return (
    <div className="p-6 max-w-6xl mx-auto">
      <header className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-extrabold">NightLit Reader</h1>
        <label className="px-3 py-1 rounded-md bg-[#0f1724] hover:bg-[#14202b] cursor-pointer text-sm">
          + Upload EPUB
          <input accept=".epub" multiple type="file" onChange={handleEpubUpload} className="hidden"/>
        </label>
      </header>

      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <aside className="md:col-span-1 space-y-3">
          {library.map(b=>(
            <div key={b.id} className="p-2 rounded-lg bg-[#04111a] hover:scale-[1.01] transition-transform cursor-pointer" onClick={()=>openBook(b.id)}>
              <div className="font-semibold">{b.title}</div>
              <div className="text-xs opacity-70">{Math.round(b.percent||0)}%</div>
            </div>
          ))}
          {library.length===0&&<div className="text-sm opacity-60 p-4">No books. Upload an EPUB to begin.</div>}
        </aside>

        <main className="md:col-span-3">
          {showLibrary&&<div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {library.map(b=>(
              <div key={b.id} className="p-4 rounded-2xl bg-gradient-to-b from-[#071728] to-[#04111a] hover:scale-[1.01] transition-transform shadow-md">
                <div className="font-bold">{b.title}</div>
                <div className="mt-2 text-xs opacity-70">{b.fileName} - {Math.round(b.percent||0)}%</div>
              </div>
            ))}
          </div>}

          {!showLibrary&&(
            <div className="relative h-[70vh] rounded-2xl bg-[#06121a] p-4 shadow-lg overflow-hidden">
              <div className="absolute left-3 top-6 flex flex-col items-center gap-2">
                <button onClick={gotoPrev} className="p-2 rounded bg-[#0f1724] hover:bg-[#14202b]">◀</button>
                <button onClick={gotoNext} className="p-2 rounded bg-[#0f1724] hover:bg-[#14202b]">▶</button>
              </div>
              <div className="absolute top-6 right-6 flex items-center gap-2">
                <div className="text-sm opacity-70">{progress}%</div>
                <button onClick={()=>{closeReader(); setShowLibrary(true);}} className="px-2 py-1 rounded bg-[#2a2a35]">Close</button>
              </div>
              <div ref={viewerRef} className="h-full w-full rounded-md bg-[#07111a]" />
            </div>
          )}
        </main>
      </div>
      <footer className="mt-6 text-xs opacity-60">Private browser reader. Progress saved locally.</footer>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
