<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Webnovel Reader</title>
<style>
body {
    background: #0f0f0f;
    color: #eee;
    font-family: 'Georgia', serif;
    margin:0; padding:0;
}
h1,h2 { text-align:center; }
#home, #reader { padding: 20px; }
#bookList { display:flex; flex-wrap:wrap; justify-content:center; }
.book-item { margin:10px; cursor:pointer; transition: transform 0.2s; text-align:center; }
.book-item:hover { transform: scale(1.05); }
.book-item img { width:120px; height:180px; border-radius:10px; }
#reader { display:none; max-width:800px; margin:auto; }
#chapterContainer { max-width:700px; margin:auto; line-height:1.8; overflow-y:auto; max-height:70vh; padding-right:10px; }
#progressBarContainer { width:100%; height:5px; background:#333; margin:10px 0; }
#progressBar { height:5px; background:#ff9c00; width:0%; }
button { background:#222; color:#eee; border:none; padding:8px 15px; cursor:pointer; border-radius:5px; margin:5px; }
button:hover { background:#444; }
input[type=file] { margin:5px; }
</style>
</head>
<body>
<div id="home">
    <h1>üìñ My Webnovels</h1>
    <input type="file" id="epubInput" accept=".epub">
    <input type="file" id="coverInput" accept="image/*">
    <button id="addBook">Add Book</button>
    <div id="bookList"></div>
</div>

<div id="reader">
    <button id="backHome">‚Üê Back</button>
    <h2 id="bookTitle"></h2>
    <div id="progressBarContainer"><div id="progressBar"></div></div>
    <div id="chapterContainer"></div>
    <div style="text-align:center; margin-top:10px;">
        <button id="prevChapter">‚óÄ Prev</button>
        <button id="nextChapter">Next ‚ñ∂</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
<script>
let db;
let currentBookId = null;
let bookList = [];
let bookRendition, currentChapter = 0;

const homeDiv = document.getElementById('home');
const readerDiv = document.getElementById('reader');
const bookListDiv = document.getElementById('bookList');
const epubInput = document.getElementById('epubInput');
const coverInput = document.getElementById('coverInput');
const addBookBtn = document.getElementById('addBook');
const bookTitle = document.getElementById('bookTitle');
const chapterContainer = document.getElementById('chapterContainer');
const progressBar = document.getElementById('progressBar');
const backHome = document.getElementById('backHome');
const prevChapterBtn = document.getElementById('prevChapter');
const nextChapterBtn = document.getElementById('nextChapter');

function openDB() {
    const request = indexedDB.open("WebnovelDB", 1);
    request.onupgradeneeded = function(e) {
        db = e.target.result;
        db.createObjectStore("books", { keyPath:"id", autoIncrement:true });
    };
    request.onsuccess = function(e) {
        db = e.target.result;
        loadBooks();
    };
    request.onerror = function(e) { console.error("DB error", e); }
}

function saveBook(epubData, coverURL, title) {
    const tx = db.transaction("books","readwrite");
    const store = tx.objectStore("books");
    store.add({title, epubData, coverURL, progress:0});
    tx.oncomplete = loadBooks;
}

function loadBooks() {
    const tx = db.transaction("books","readonly");
    const store = tx.objectStore("books");
    const req = store.getAll();
    req.onsuccess = function(e){
        bookList = e.target.result;
        renderBooks();
    };
}

function renderBooks() {
    bookListDiv.innerHTML = '';
    bookList.forEach(book => {
        const div = document.createElement('div');
        div.className = 'book-item';
        div.innerHTML = `<img src="${book.coverURL}" alt="${book.title}"><div>${book.title}</div>`;
        div.onclick = () => openReader(book.id);
        bookListDiv.appendChild(div);
    });
}

addBookBtn.onclick = () => {
    const epubFile = epubInput.files[0];
    const coverFile = coverInput.files[0];
    if(!epubFile || !coverFile) return alert("Select EPUB and cover!");

    const reader = new FileReader();
    reader.onload = (e) => {
        const coverURL = URL.createObjectURL(coverFile);
        saveBook(e.target.result, coverURL, epubFile.name);
    };
    reader.readAsArrayBuffer(epubFile);
}

function openReader(id) {
    const book = bookList.find(b=>b.id===id);
    if(!book) return;
    currentBookId = id;
    homeDiv.style.display='none';
    readerDiv.style.display='block';
    bookTitle.textContent = book.title;
    chapterContainer.innerHTML = '';
    currentChapter = book.progress || 0;

    const bookBlob = new Blob([book.epubData], {type:"application/epub+zip"});
    const bookURL = URL.createObjectURL(bookBlob);
    const epub = ePub(bookURL);
    bookRendition = epub.renderTo(chapterContainer,{ width:'100%', height:'70vh' });
    epub.ready.then(()=>{
        bookRendition.display(currentChapter);
        updateProgress();
        bookRendition.on("relocated", loc => updateProgress());
    });
}

function updateProgress() {
    const book = bookList.find(b=>b.id===currentBookId);
    if(!book) return;
    let loc = bookRendition.location? bookRendition.location.start.cfi : 0;
    progressBar.style.width = `${bookRendition.location? bookRendition.location.start.percentage*100 : 0}%`;
    book.progress = loc;
    const tx = db.transaction("books","readwrite");
    tx.objectStore("books").put(book);
}

backHome.onclick = () => { readerDiv.style.display='none'; homeDiv.style.display='block'; }
prevChapterBtn.onclick = ()=> bookRendition.prev();
nextChapterBtn.onclick = ()=> bookRendition.next();

openDB();
</script>
</body>
</html>
