<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Comick Immersive Reader</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/epubjs/dist/epub.min.js"></script>
<style>
:root{--bg:#0d0d0f;--panel:#121216;--muted:#9b9b9b;--accent:#f5f5dc}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Playfair Display',serif;background:var(--bg);color:var(--accent);}
#app{display:flex;min-height:100vh}
#sidebar{width:320px;padding:28px;background:linear-gradient(180deg,#0b0b0d,#0f0f12);border-right:1px solid rgba(255,255,255,0.03)}
#main{flex:1;padding:28px;display:flex;flex-direction:column;align-items:center;position:relative}
h1{margin:0 0 12px 0;font-size:20px;letter-spacing:1px}
.controls{margin:12px 0 22px 0}
input[type=file]{display:block;margin-bottom:10px}
.add-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:var(--accent);cursor:pointer;transition:all .18s ease}
.add-btn:hover{border-color:var(--accent);}
.tiles{display:flex;flex-wrap:wrap;gap:18px}
.tile{width:160px;height:240px;border-radius:10px;overflow:hidden;position:relative;background:#18181a;box-shadow:0 6px 18px rgba(0,0,0,0.6);cursor:pointer;transition:transform .25s,box-shadow .25s}
.tile img{width:100%;height:100%;object-fit:cover;display:block}
.tile:hover{transform:translateY(-6px) scale(1.02);box-shadow:0 12px 30px rgba(0,0,0,0.7)}
.tile .meta{position:absolute;left:0;right:0;bottom:0;padding:10px;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.6));display:flex;justify-content:space-between;align-items:center}
.tile .meta .title{font-size:13px}
.tile .meta .resume{font-size:12px;color:var(--muted)}
#readerWrap{display:none;flex-direction:column;align-items:center;position:relative;width:100%;height:100vh}
#readerHeader{width:100%;display:flex;justify-content:space-between;align-items:center;padding:22px 40px;position:fixed;top:0;left:0;z-index:50;background:linear-gradient(180deg, rgba(10,10,10,0.9), transparent);backdrop-filter: blur(2px)}
#readerHeader h2{margin:0;font-size:18px}
#viewerContainer{width:820px;max-width:92%;margin-top:98px;margin-bottom:80px;position:relative}
#viewer{background:rgba(0,0,0,0.35);padding:36px 48px;border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,0.7);max-height:74vh;overflow:auto}
#viewer p{opacity:0;margin:0 0 1.15em 0;line-height:1.8;font-size:18px;transition:opacity .8s ease}
#viewer p.visible{opacity:1}
#viewer .dropcap{float:left;font-size:64px;line-height:56px;padding-right:12px;padding-top:8px;color:var(--accent)}
#progressBar{position:fixed;right:20px;top:20px;width:10px;height:60vh;background:rgba(255,255,255,0.03);border-radius:20px;overflow:hidden}
#progressFill{width:100%;height:0;background:linear-gradient(180deg,var(--accent),#d4d4b8)}
.nav{position:fixed;left:0;right:0;bottom:24px;display:flex;justify-content:space-between;padding:0 40px;pointer-events:none}
.nav button{pointer-events:auto;background:linear-gradient(145deg,#2a2a2a,#171717);border-radius:28px;padding:14px 22px;border:none;color:var(--accent);font-size:16px;box-shadow:0 8px 22px rgba(0,0,0,0.6);cursor:pointer;transition:transform .18s,box-shadow .18s}
.nav button:hover{transform:scale(1.06);box-shadow:0 14px 34px rgba(0,0,0,0.75)}
.nav button:active{transform:scale(.96)}
#fog{position:fixed;inset:0;background:radial-gradient(circle at 50% 40%, rgba(255,255,255,0.02), rgba(255,255,255,0.01) 10%, rgba(0,0,0,0.85) 40%);pointer-events:none;opacity:0;transition:opacity .6s;z-index:90}
#cursorGlow{position:fixed;width:22px;height:22px;border-radius:50%;pointer-events:none;mix-blend-mode:screen;box-shadow:0 0 32px 10px rgba(245,245,220,0.22);transform:translate(-50%,-50%);z-index:200;transition:all .18s ease}
@media (max-width:900px){#sidebar{display:none}#viewer{padding:22px}}
</style>
</head>
<body>
<div id="app">
  <aside id="sidebar">
    <h1>Comick Library</h1>
    <div class="controls">
      <label class="add-btn">Add Series (EPUB)
        <input id="epubInput" type="file" accept=".epub">
      </label>
      <label class="add-btn">Upload Cover
        <input id="coverInput" type="file" accept="image/*">
      </label>
      <button id="clearSeries" class="add-btn">Delete Selected Series</button>
    </div>
    <div id="statusMsg" style="color:var(--muted);font-size:13px;margin-top:10px">Ready</div>
    <div style="height:24px"></div>
    <div style="color:var(--muted);font-size:13px;">Series stored in browser. Back up EPUBs if needed.</div>
    <div class="tiles" id="tiles"></div>
  </aside>
  <main id="main">
    <div id="readerWrap">
      <div id="readerHeader">
        <h2 id="seriesTitle">Series</h2>
        <div>
          <button id="gotoHome" class="add-btn">Library</button>
        </div>
      </div>
      <div id="viewerContainer">
        <div id="viewer" tabindex="0"></div>
      </div>
      <div id="progressBar"><div id="progressFill"></div></div>
      <div class="nav">
        <button id="prevBtn">⟵ Prev</button>
        <button id="nextBtn">Next ⟶</button>
      </div>
    </div>
  </main>
</div>
<div id="fog"></div>
<div id="cursorGlow"></div>

<script>
// IndexedDB setup
const DB_NAME='comickDB',STORE_NAME='seriesStore';
let db;
function openDB(){return new Promise((res,rej)=>{
  const r=indexedDB.open(DB_NAME,1);
  r.onupgradeneeded=e=>{db=e.target.result;db.createObjectStore(STORE_NAME,{keyPath:'id'});};
  r.onsuccess=e=>{db=e.target.result;res(db);};
  r.onerror=e=>rej(e);
})}
function saveSeries(series){return new Promise(async res=>{
  if(!db) await openDB();
  const tx=db.transaction(STORE_NAME,'readwrite');
  tx.objectStore(STORE_NAME).put(series);
  tx.oncomplete=()=>res();
})}
function getSeries(){return new Promise(async res=>{
  if(!db) await openDB();
  const tx=db.transaction(STORE_NAME,'readonly');
  const store=tx.objectStore(STORE_NAME);
  const req=store.getAll();
  req.onsuccess=()=>res(req.result);
})}

// cursor glow
const cursorGlow=document.getElementById('cursorGlow');
document.addEventListener('mousemove',e=>{cursorGlow.style.left=e.clientX+'px';cursorGlow.style.top=e.clientY+'px';});

// UI Elements
const epubInput=document.getElementById('epubInput');
const coverInput=document.getElementById('coverInput');
const tilesDiv=document.getElementById('tiles');
const viewer=document.getElementById('viewer');
const readerWrap=document.getElementById('readerWrap');
const seriesTitle=document.getElementById('seriesTitle');
const gotoHome=document.getElementById('gotoHome');
const prevBtn=document.getElementById('prevBtn');
const nextBtn=document.getElementById('nextBtn');
const progressFill=document.getElementById('progressFill');

let library=[],currentSeries=null,book=null,spineItems=[],currentIndex=0;

// Load library
async function loadLibrary(){
  library=await getSeries();
  tilesDiv.innerHTML='';
  library.forEach(s=>{
    const div=document.createElement('div'); div.className='tile';
    if(s.cover){div.style.backgroundImage=`url(${s.cover})`;div.style.backgroundSize='cover';}
    div.onclick=()=>openSeries(s.id);
    div.oncontextmenu=e=>{e.preventDefault();currentSeries=s;};
    div.innerHTML=`<div class="meta"><span class="title">${s.title||s.id}</span><span class="resume">Chapter ${s.lastIndex||1}</span></div>`;
    tilesDiv.appendChild(div);
  });
}

// Open series
async function openSeries(id){
  currentSeries=library.find(s=>s.id===id);
  seriesTitle.textContent=currentSeries.title||currentSeries.id;
  readerWrap.style.display='flex';
  tilesDiv.parentElement.scrollTop=0;
  const data=await fetch(URL.createObjectURL(currentSeries.file)).then(r=>r.arrayBuffer());
  book=EPUB(data);
  spineItems=book.spine.spineItems.map(s=>s.href);
  currentIndex=currentSeries.lastIndex||0;
  renderChapter();
}

// Render chapter
async function renderChapter(){
  if(!book) return;
  const item=book.spine.spineItems[currentIndex];
  const content=await item.load(book.load.bind(book));
  viewer.innerHTML='';
  const parser=new DOMParser();
  const doc=parser.parseFromString(content,'application/xml');
  doc.querySelectorAll('p').forEach(p=>{
    const para=document.createElement('p');
    para.textContent=p.textContent; para.classList.add('visible'); viewer.appendChild(para);
  });
  progressFill.style.height=((currentIndex+1)/spineItems.length*100)+'%';
}

// Navigation
prevBtn.onclick=()=>{if(currentIndex>0){currentIndex--;renderChapter();updateProgress();}};
nextBtn.onclick=()=>{if(currentIndex<spineItems.length-1){currentIndex++;renderChapter();updateProgress();}};
function updateProgress(){if(currentSeries){currentSeries.lastIndex=currentIndex;saveSeries(currentSeries);}}

// File upload
epubInput.onchange=async e=>{
  if(!e.target.files[0]) return;
  const file=e.target.files[0];
  const id=file.name;
  currentSeries={id,file,title:file.name,lastIndex:0};
  library.push(currentSeries);
  saveSeries(currentSeries); loadLibrary();
};
coverInput.onchange=e=>{
  if(!currentSeries) return alert('Select series first (right click)');
  const file=e.target.files[0];
  const url=URL.createObjectURL(file);
  currentSeries.cover=url; saveSeries(currentSeries); loadLibrary();
};

// Delete
document.getElementById('clearSeries').onclick=()=>{
  if(!currentSeries) return alert('Right click a series first'); 
  db.transaction(STORE_NAME,'readwrite').objectStore(STORE_NAME).delete(currentSeries.id).oncomplete=()=>{currentSeries=null;loadLibrary();};
};

// Back to library
gotoHome.onclick=()=>{readerWrap.style.display='none';}

// Init
loadLibrary();
</script>
</body>
</html>
